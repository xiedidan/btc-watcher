#!/bin/bash

# å•å…ƒæµ‹è¯•è¿è¡Œè„šæœ¬ï¼ˆä½¿ç”¨è™šæ‹Ÿç¯å¢ƒï¼‰
# Unit Test Runner with Virtual Environment

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘            BTC Watcher å•å…ƒæµ‹è¯•è¿è¡Œå™¨ï¼ˆvenvï¼‰                 â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# è¿›å…¥backendç›®å½•
cd "$(dirname "$0")/../backend" || exit 1

# æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒæ˜¯å¦å­˜åœ¨
if [ ! -d "venv" ]; then
    echo "ğŸ“¦ åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv venv
    echo "âœ… è™šæ‹Ÿç¯å¢ƒåˆ›å»ºæˆåŠŸ"
fi

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
echo "ğŸ”§ æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ..."
source venv/bin/activate

# æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–
echo "ğŸ“¦ æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–..."
pip install -q --upgrade pip

# å®‰è£…ä¸»è¦ä¾èµ–
if [ -f "requirements.txt" ]; then
    echo "   å®‰è£…ä¸»è¦ä¾èµ–..."
    pip install -q -r requirements.txt
fi

# å®‰è£…æµ‹è¯•ä¾èµ–
if [ -f "requirements-test.txt" ]; then
    echo "   å®‰è£…æµ‹è¯•ä¾èµ–..."
    pip install -q -r requirements-test.txt
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š è¿è¡Œå•å…ƒæµ‹è¯•..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# è¿è¡Œæµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š
python -m pytest tests/unit/ \
    -v \
    --tb=short \
    --cov=. \
    --cov-report=term-missing \
    --cov-report=html \
    -p no:warnings \
    "$@"

TEST_RESULT=$?

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ $TEST_RESULT -eq 0 ]; then
    echo "âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ï¼"
    echo ""
    echo "ğŸ“Š æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ: htmlcov/index.html"
else
    echo "âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šæ–¹è¾“å‡º"
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

exit $TEST_RESULT
