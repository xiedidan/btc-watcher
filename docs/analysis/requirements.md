# BTC Watcher 需求文档

## 项目概述
BTC Watcher 是一个专为个人交易者设计的电子货币监控系统，主要用于监控加密货币价格走势、技术指标，并通过多种渠道发送交易信号通知。系统注重易用性和部署便捷性，充分利用FreqTrade框架和CCXT库的数据获取能力。

## 核心功能需求

### 1. Web UI 管理界面

#### 1.1 策略管理（图形化配置）
- **功能**: 创建、配置、启停多个监控策略
- **图形化配置**: 通过Web UI进行所有策略参数配置，无需编辑配置文件
- **交易对管理**: 在策略级别管理监控的交易对，每个策略可配置专属交易对列表
- **参数配置**: 策略参数的可视化配置界面（如MA周期、RSI阈值等）
- **进程状态**: 实时显示策略运行状态（运行中/已停止/错误）
- **日志查看**: 查看策略运行日志和错误信息
- **心跳监控**: 实时监控策略进程心跳，自动检测无响应策略
  - 监控FreqTrade进程的心跳日志（格式：`Bot heartbeat. PID=xxx, version='xxx', state='RUNNING'`）
  - 支持配置心跳超时时间（默认5分钟）
  - 心跳超时后发送告警通知
  - 支持配置自动重启功能（可选，默认开启）
  - 记录心跳异常和重启历史
  - 通过NotifyHub发送心跳异常告警

#### 1.2 网络代理管理
- **代理配置**: 支持HTTP/SOCKS代理设置，用于访问交易所API
- **连通性测试**: 测试代理服务器的连通性和稳定性
- **性能评估**: 评估代理的响应延迟、成功率、数据获取速度
- **多代理支持**: 支持配置多个代理进行轮换使用
- **代理监控**: 实时监控代理使用状态和性能指标

#### 1.3 图表展示（TradingView风格）
- **界面布局**: 参考TradingView的组织形式
  - 左侧：货币对列表 + 筛选功能
  - 中间：K线图表 + 成交量图
  - 右侧：策略信号详情
  - 底部：策略列表 + 快速切换
- **多策略信号叠加**: 在同一图表上显示所有策略的买卖信号
- **信号标注**: 不同策略使用不同颜色/图标标记信号
- **交互功能**: 可选择显示/隐藏特定策略的信号，点击信号查看详细信息
- **图表组件**:
  - K线主图：显示价格走势（开、高、低、收）
  - 成交量副图：显示交易量变化
  - 信号标记：在K线图上标记买卖信号点
- **时间周期**: 支持多种时间周期切换（1m、5m、15m、1h、4h、1d）
- **技术指标**: 暂不实现（第二期迭代）

#### 1.4 市场数据服务
- **数据源管理**:
  - 支持多交易所数据源：Binance（默认）、OKX、Bybit、Bitget
  - 交易所可在系统配置中选择和切换
  - 支持自动故障切换（可配置），图表显示当前使用的交易所
  - 基于CCXT库统一数据接口

- **K线数据获取**:
  - 默认获取200根K线，支持加载更多历史数据
  - 支持多时间周期：1m、5m、15m、1h、4h、1d
  - 历史数据初始化策略：
    - 1m: 7天历史数据
    - 5m/15m: 30天历史数据
    - 1h: 90天历史数据
    - 4h/1d: 1年历史数据

- **缓存策略**:
  - Redis缓存K线数据
  - 缓存TTL可配置（默认：1m=60s, 5m=300s, 15m=900s, 1h=3600s, 4h=14400s, 1d=86400s）
  - 缓存容量可配置（默认512MB）
  - 三层数据访问优先级：Redis缓存 → PostgreSQL存储 → CCXT API

- **数据更新策略**:
  - 支持两种更新模式（可在系统配置中切换）：
    - **固定间隔模式**: 所有周期统一按固定时间间隔更新（如5秒或实时）
    - **N周期模式**: 按周期倍数更新（N=1时，1d用4h更新，4h用1h更新，以此类推）
  - 更新频率参数可配置

- **限流处理与降级**:
  - 优先使用缓存数据，避免频繁API请求
  - API限流时自动降级到缓存/存储数据
  - 限流降级策略：API → Redis → PostgreSQL
  - 显示数据来源和更新时间

- **数据持久化**:
  - K线数据长期存储到PostgreSQL
  - 数据分区和清理策略（按时间周期不同设置保留期）
  - 支持数据导出和备份

#### 1.5 通知设置
- **通知渠道配置**: 微信、飞书、Telegram、邮件
- **通知规则**: 支持按策略、货币对、信号类型设置通知
- **消息模板**: 自定义通知消息格式
- **通知历史**: 记录所有通知发送历史和状态

### 2. FreqTrade 监控策略

#### 2.1 数据获取策略
- **技术实现**: 充分利用FreqTrade框架和CCXT库的数据获取能力
- **交易所支持**: 通过CCXT支持Binance、OKX、Bybit等主流交易所
- **代理支持**: 策略实例支持使用配置的网络代理访问交易所API
- **数据管理**: FreqTrade负责实时数据获取和历史数据管理

#### 2.2 策略框架
- **基础**: 基于FreqTrade框架开发
- **模式**: 仅输出信号，不执行实际交易（Dry-run模式）
- **多策略**: 支持同时运行多个策略实例，每个实例独立配置
- **动态配置**: 支持通过Web UI动态生成和更新策略配置文件
- **热更新**: 支持不重启服务更新策略参数

#### 2.3 信号输出
- **信号类型**: 买入信号、卖出信号、止损信号
- **信号数据**: 包含时间、货币对、价格、信号强度、策略名称、技术指标值
- **存储方式**: 将信号存储到数据库，供Web界面查询展示
- **实时推送**: 信号产生后立即推送到通知系统

### 3. 通知系统

#### 3.1 通知渠道
- **微信**: 通过企业微信或微信测试号发送
- **飞书**: 通过飞书机器人发送群消息
- **Telegram**: 通过 Telegram Bot 发送消息
- **邮件**: SMTP 邮件通知

#### 3.2 通知管理
- **实时通知**: 策略产生信号时立即发送
- **批量通知**: 支持定时汇总发送
- **通知历史**: 记录所有通知发送历史
- **失败重试**: 通知发送失败时自动重试
- **代理支持**: 通知服务支持使用网络代理发送消息

## 非功能性需求

### 4.1 性能要求（调整）
- **响应时间**: Web界面操作响应时间 < 2秒
- **数据延迟**: 价格数据延迟 < 10秒（通过FreqTrade/CCXT获取）
- **并发处理**: 支持同时监控至少100个货币对
- **系统稳定性**: 7*24小时稳定运行
- **资源占用**: 内存 < 4GB，CPU < 80%（放宽限制）

### 4.2 部署要求
- **容器化**: 完全Docker化部署
- **跨平台**: 支持WSL2和Linux环境
- **一键部署**: 提供启停脚本，简化运维操作
- **配置管理**: 配置文件外部化，方便修改
- **简化架构**: 减少不必要的服务间通信，降低部署复杂度

### 4.3 数据要求
- **数据持久化**: 所有配置和历史数据持久化存储
- **数据备份**: 支持数据导出和恢复
- **数据安全**: 敏感信息（如代理密码、API密钥）加密存储

### 4.4 监控要求
- **健康检查**: 各组件健康状态监控
- **错误处理**: 完善的错误处理和恢复机制
- **日志管理**: 结构化日志输出，便于问题排查
- **代理监控**: 实时监控网络代理的使用状态和性能
- **策略心跳监控**: 监控FreqTrade策略进程的心跳日志，自动检测进程无响应并触发重启

## 用户角色和权限

### 5.1 管理员用户
- 系统配置管理
- 策略创建和修改（图形化界面）
- 网络代理配置和测试
- 通知渠道配置
- 系统监控和维护

## 技术约束

### 6.1 开发约束
- **框架选择**: 充分利用FreqTrade和CCXT的成熟生态
- **架构简化**: 优先使用成熟的开源框架和工具，避免重复造轮子
- **代码结构**: 代码结构清晰，便于个人维护
- **文档要求**: 详细的文档和注释

### 6.2 部署约束
- **依赖最小化**: 最小化依赖，降低部署复杂度
- **离线支持**: 支持离线部署
- **资源合理**: 资源占用合理（内存 < 4GB，CPU < 80%）
- **网络环境**: 支持通过代理访问受限网络环境

## 验收标准

1. **功能完整性**: 所有核心功能正常工作，图形化配置界面完整可用
2. **易用性**: 非技术用户能够通过Web UI快速配置策略和代理
3. **稳定性**: 连续运行一周无崩溃，代理切换正常
4. **部署便捷性**: 新环境部署时间 < 30分钟
5. **通知及时性**: 信号产生到通知发送时间 < 10秒
6. **代理功能**: 代理测试和性能评估功能正常工作
7. **图表功能**: TradingView风格的图表界面，支持多策略信号叠加展示

## 系统架构简化说明

### 取消的复杂组件
- ❌ 独立的价格数据采集服务
- ❌ 独立的数据同步服务
- ❌ 复杂的分区表和数据管理

### 保留的核心组件
- ✅ Web UI (Vue.js) - 图形化配置界面
- ✅ API Backend (FastAPI) - 业务逻辑和配置管理
- ✅ FreqTrade Service - 策略执行和数据获取
- ✅ Notification Service - 多渠道通知
- ✅ PostgreSQL + Redis - 数据存储和缓存

### 架构优势
- 🚀 降低系统复杂度，提高稳定性
- 🔧 减少维护成本，便于个人管理
- 📊 充分利用FreqTrade/CCXT的成熟功能
- 🌐 增强网络代理支持，适应各种网络环境