# NotifyHub é€šçŸ¥ä¸­å¿ƒè®¾è®¡æ€»ç»“

## ğŸ“‹ æ–‡æ¡£æ›´æ–°è¯´æ˜

å·²å®Œæˆå¯¹ä»¥ä¸‹ä¸¤ä¸ªè®¾è®¡æ–‡æ¡£çš„æ›´æ–°ï¼š

1. **DESIGN.md** - ç¬¬2.4èŠ‚"NotifyHub é€šçŸ¥ä¸­å¿ƒè®¾è®¡"
2. **API_DESIGN.md** - ç¬¬2.7èŠ‚"NotifyHub é€šçŸ¥ä¸­å¿ƒæ¥å£"

---

## ğŸ—ï¸ NotifyHub æ ¸å¿ƒè®¾è®¡

### 1. è®¾è®¡ç†å¿µ

**é—®é¢˜åœºæ™¯**ï¼š
- ä¸šåŠ¡ä»£ç æ•£è½å„å¤„éƒ½åœ¨ç›´æ¥è°ƒç”¨é€šçŸ¥API
- é€šçŸ¥é…ç½®ç¡¬ç¼–ç ï¼Œéš¾ä»¥ç®¡ç†
- ç¼ºä¹ç»Ÿä¸€çš„é¢‘ç‡æ§åˆ¶ï¼Œå®¹æ˜“é€ æˆé€šçŸ¥è½°ç‚¸
- æ— æ³•æ ¹æ®æ—¶é—´è§„åˆ™ï¼ˆå¦‚å‹¿æ‰°æ—¶æ®µï¼‰æ™ºèƒ½å‘é€

**NotifyHubè§£å†³æ–¹æ¡ˆ**ï¼š
```python
# ä¸šåŠ¡ä»£ç åªéœ€è¦ä¸€è¡Œ
await notify_hub.notify(
    user_id=1,
    title="å¼ºä¹°å…¥ä¿¡å·",
    message="BTC/USDT å‡ºç°å¼ºä¹°å…¥ä¿¡å·ï¼Œä¿¡å·å¼ºåº¦85%",
    notification_type="signal",
    priority="P2",  # æœ€é«˜ä¼˜å…ˆçº§ï¼Œç«‹å³å‘é€
    metadata={"pair": "BTC/USDT", "strength": 0.85}
)

# é€šçŸ¥çš„å…·ä½“å»å‘ç”±ç”¨æˆ·é…ç½®å†³å®šï¼Œä¸šåŠ¡ä»£ç æ— éœ€å…³å¿ƒ
```

### 2. æ ¸å¿ƒæ¶æ„

```
ä¸šåŠ¡å±‚ (ç­–ç•¥å¼•æ“ã€ç³»ç»Ÿç›‘æ§ã€æ•°æ®åŒæ­¥)
        â†“ è°ƒç”¨ notify_hub.notify()
NotifyHubæ ¸å¿ƒ
â”œâ”€ è·¯ç”±å¼•æ“ï¼šæ ¹æ®è§„åˆ™å†³å®šå‘é€åˆ°å“ªäº›æ¸ é“
â”œâ”€ é¢‘ç‡æ§åˆ¶ï¼šP0æ‰¹é‡å‘é€ã€P1é™é¢‘ã€P2ç«‹å³å‘é€
â”œâ”€ æ—¶é—´è§„åˆ™ï¼šå‹¿æ‰°æ—¶æ®µã€å·¥ä½œæ—¶é—´ã€å‘¨æœ«/å‡æœŸæ¨¡å¼
â”œâ”€ æ¨¡æ¿æ¸²æŸ“ï¼šä½¿ç”¨æ¨¡æ¿æ ¼å¼åŒ–æ¶ˆæ¯
â””â”€ å¤±è´¥é‡è¯•ï¼šè‡ªåŠ¨é‡è¯•å¤±è´¥çš„é€šçŸ¥
        â†“
é€šçŸ¥æ¸ é“ (Telegram, é£ä¹¦, ä¼ä¸šå¾®ä¿¡, é‚®ä»¶, çŸ­ä¿¡)
        â†“
é€šçŸ¥å†å² (PostgreSQL æ°¸ä¹…è®°å½•)
```

### 3. ä¼˜å…ˆçº§ç®¡ç† (P0/P1/P2)

| ä¼˜å…ˆçº§ | åç§° | å‘é€ç­–ç•¥ | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|--------|------|----------|----------|------|
| **P2** | æœ€é«˜ | ç«‹å³å‘é€ï¼Œæ— é™åˆ¶ | ç³»ç»Ÿå´©æºƒã€ç­–ç•¥å¼‚å¸¸ã€å¼ºä¿¡å· | ç­–ç•¥å¼‚å¸¸åœæ­¢ã€å¼ºä¹°å…¥ä¿¡å·(>=80%) |
| **P1** | ä¸­ç­‰ | é™é¢‘å‘é€ï¼ˆé»˜è®¤60ç§’é—´éš”ï¼‰ | é‡è¦ä¿¡æ¯ã€ä¸­ç­‰ä¿¡å· | ä¸­ç­‰ä¹°å…¥ä¿¡å·(50-80%)ã€ä»£ç†è¿æ¥å¤±è´¥ |
| **P0** | æœ€ä½ | æ‰¹é‡å‘é€ï¼ˆé»˜è®¤5åˆ†é’Ÿä¸€æ‰¹ï¼‰ | æ—¥å¸¸ä¿¡æ¯ã€å¼±ä¿¡å· | å¼±ä¹°å…¥ä¿¡å·(<50%)ã€ç­–ç•¥å¿ƒè·³ã€æ•°æ®åŒæ­¥å®Œæˆ |

**è‡ªåŠ¨ä¼˜å…ˆçº§æ˜ å°„**ï¼š
```python
# ç¤ºä¾‹ï¼šæ ¹æ®ä¿¡å·å¼ºåº¦è‡ªåŠ¨é€‰æ‹©ä¼˜å…ˆçº§
def get_priority_by_signal_strength(strength: float) -> str:
    if strength >= 0.8:
        return "P2"  # å¼ºä¿¡å·ï¼Œç«‹å³é€šçŸ¥
    elif strength >= 0.5:
        return "P1"  # ä¸­ç­‰ä¿¡å·ï¼Œé™é¢‘é€šçŸ¥
    else:
        return "P0"  # å¼±ä¿¡å·ï¼Œæ‰¹é‡é€šçŸ¥
```

### 4. é€šçŸ¥è·¯ç”±è§„åˆ™

NotifyHubæ ¹æ®ä»¥ä¸‹å› ç´ å†³å®šé€šçŸ¥å»å‘ï¼š

1. **æ¸ é“å¯ç”¨çŠ¶æ€**ï¼šæ˜¯å¦å¯ç”¨è¯¥æ¸ é“
2. **ä¼˜å…ˆçº§æ”¯æŒ**ï¼šæ¸ é“æ˜¯å¦æ”¯æŒè¯¥ä¼˜å…ˆçº§ï¼ˆä¾‹å¦‚çŸ­ä¿¡åªæ¥æ”¶P2ï¼‰
3. **é¢‘ç‡é™åˆ¶**ï¼šæ˜¯å¦è¶…è¿‡å‘é€é¢‘ç‡é™åˆ¶
4. **æ—¶é—´è§„åˆ™**ï¼šæ˜¯å¦åœ¨å‹¿æ‰°æ—¶æ®µã€å·¥ä½œæ—¶é—´ç­‰

**ç¤ºä¾‹é…ç½®**ï¼š
```json
{
  "channels": [
    {
      "type": "telegram",
      "enabled": true,
      "supported_priorities": ["P0", "P1", "P2"],  // æ¥æ”¶æ‰€æœ‰ä¼˜å…ˆçº§
      "max_per_hour": 60
    },
    {
      "type": "sms",
      "enabled": true,
      "supported_priorities": ["P2"],  // ä»…æ¥æ”¶æœ€é«˜ä¼˜å…ˆçº§
      "max_per_day": 10
    }
  ]
}
```

### 5. æ—¶é—´è§„åˆ™ç¤ºä¾‹

#### 5.1 å‹¿æ‰°æ—¶æ®µ
```json
{
  "quiet_hours_enabled": true,
  "quiet_start_time": "22:00",
  "quiet_end_time": "08:00",
  "quiet_priority_filter": "P2"  // å‹¿æ‰°æ—¶æ®µåªå‘é€P2ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
}
```

#### 5.2 å‘¨æœ«æ¨¡å¼
```json
{
  "weekend_mode_enabled": true,
  "weekend_downgrade_p1_to_p0": true,  // å‘¨æœ«å°†P1é™çº§ä¸ºP0
  "weekend_batch_p0": true  // å‘¨æœ«æ‰¹é‡å‘é€P0
}
```

#### 5.3 å·¥ä½œæ—¶é—´é™åˆ¶
```json
{
  "working_hours_enabled": true,
  "working_start_time": "09:00",
  "working_end_time": "18:00",
  "working_days": [1, 2, 3, 4, 5]  // å‘¨ä¸€åˆ°å‘¨äº”
}
```

### 6. æ‰¹é‡å‘é€æœºåˆ¶

**P0é€šçŸ¥æ‰¹é‡å‘é€æµç¨‹**ï¼š
1. P0é€šçŸ¥åˆ°è¾¾æ—¶ï¼Œä¸ç«‹å³å‘é€ï¼ŒåŠ å…¥æ‰¹é‡é˜Ÿåˆ—
2. æ¯5åˆ†é’Ÿï¼ˆå¯é…ç½®ï¼‰è§¦å‘ä¸€æ¬¡æ‰¹é‡å‘é€
3. å°†é˜Ÿåˆ—ä¸­çš„å¤šæ¡P0é€šçŸ¥åˆå¹¶ä¸ºä¸€æ¡å‘é€
4. åˆå¹¶è§„åˆ™ï¼šæŒ‰ç±»å‹åˆ†ç»„ï¼Œæ±‡æ€»ä¿¡æ¯

**æ‰¹é‡é€šçŸ¥ç¤ºä¾‹**ï¼š
```
ğŸ“Š æ‰¹é‡ä¿¡å·é€šçŸ¥ï¼ˆ8æ¡ï¼‰

1. BTC/USDT å¼±ä¹°å…¥ä¿¡å· (å¼ºåº¦: 45%)
2. ETH/USDT å¼±å–å‡ºä¿¡å· (å¼ºåº¦: 38%)
3. SOL/USDT å¼±ä¹°å…¥ä¿¡å· (å¼ºåº¦: 42%)
...

â° æ—¶é—´èŒƒå›´: 14:20 - 14:25
```

---

## ğŸ”Œ API è®¾è®¡äº®ç‚¹

### 1. ç»Ÿä¸€çš„é€šçŸ¥å‘é€æ¥å£

```http
POST /api/v1/notify/send

{
  "title": "å¼ºä¹°å…¥ä¿¡å·",
  "message": "BTC/USDT å‡ºç°å¼ºä¹°å…¥ä¿¡å·",
  "notification_type": "signal",
  "priority": "P2",
  "metadata": {"pair": "BTC/USDT", "strength": 0.85}
}
```

### 2. å®Œæ•´çš„é…ç½®ç®¡ç†

#### æ¸ é“é…ç½®
- `GET/POST/PUT/DELETE /api/v1/notify/channels`
- `POST /api/v1/notify/channels/{id}/test` - æµ‹è¯•è¿æ¥

**æ”¯æŒçš„é€šçŸ¥æ¸ é“**:
- âœ… **Telegram Bot** - æ”¯æŒMarkdownæ ¼å¼æ¶ˆæ¯
- âœ… **Discord Bot/Webhook** - æ”¯æŒEmbedæ ¼å¼ï¼Œé¢œè‰²è‡ªåŠ¨æ˜ å°„
- âœ… **é£ä¹¦ Webhook** - æ”¯æŒå¡ç‰‡æ¶ˆæ¯
- âœ… **ä¼ä¸šå¾®ä¿¡** - ä¼ä¸šå†…éƒ¨é€šçŸ¥
- âœ… **é‚®ä»¶** - SMTPå‘é€
- âœ… **çŸ­ä¿¡** - ç¬¬ä¸‰æ–¹çŸ­ä¿¡æœåŠ¡

#### é¢‘ç‡é™åˆ¶
- `GET/PUT /api/v1/notify/frequency-limits`

#### æ—¶é—´è§„åˆ™
- `GET/POST/PUT/DELETE /api/v1/notify/time-rules`

#### é€šçŸ¥æ¨¡æ¿
- `GET/POST/PUT/DELETE /api/v1/notify/templates`
- `POST /api/v1/notify/templates/{id}/test` - æµ‹è¯•æ¨¡æ¿

### 3. å¼ºå¤§çš„æŸ¥è¯¢å’Œç»Ÿè®¡

#### é€šçŸ¥å†å²
```http
GET /api/v1/notify/history?priority=P2&status=sent&start_time=2024-01-15
```

#### ç»Ÿè®¡ä¿¡æ¯
```http
GET /api/v1/notify/stats?period=today

Response:
{
  "total_notifications": 156,
  "by_priority": {"P2": 23, "P1": 85, "P0": 48},
  "by_channel": {"telegram": 89, "feishu": 67},
  "success_rate": 0.949
}
```

#### æ¸ é“ç»Ÿè®¡
```http
GET /api/v1/notify/stats/channels

Response:
{
  "channels": [{
    "channel_type": "telegram",
    "total_sent": 1234,
    "success_rate": 0.990,
    "daily_usage": {
      "sent_today": 45,
      "limit_per_day": 500,
      "remaining": 455
    }
  }]
}
```

### 4. ç³»ç»Ÿç®¡ç†æ¥å£

```http
GET /api/v1/notify/system/health    # å¥åº·æ£€æŸ¥
GET /api/v1/notify/system/queue     # æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€
POST /api/v1/notify/system/flush-batch  # æ‰‹åŠ¨è§¦å‘æ‰¹é‡å‘é€
```

---

## ğŸ“Š æ•°æ®åº“è¡¨è®¾è®¡

NotifyHubä½¿ç”¨4å¼ æ ¸å¿ƒè¡¨ï¼ˆå·²åœ¨ `models/notification.py` ä¸­å®šä¹‰ï¼‰ï¼š

### 1. notification_channel_configs
é€šçŸ¥æ¸ é“é…ç½®è¡¨
- ç”¨æˆ·çš„é€šçŸ¥æ¸ é“ï¼ˆTelegramã€é£ä¹¦ç­‰ï¼‰
- æ¸ é“å¯ç”¨çŠ¶æ€ã€ä¼˜å…ˆçº§æ”¯æŒ
- é¢‘ç‡é™åˆ¶ï¼ˆæ¯å°æ—¶/æ¯å¤©æœ€å¤§é€šçŸ¥æ•°ï¼‰
- ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ€»å‘é€æ•°ã€å¤±è´¥æ•°ã€æœ€åå‘é€æ—¶é—´ï¼‰

### 2. notification_frequency_limits
é€šçŸ¥é¢‘ç‡é™åˆ¶é…ç½®è¡¨
- P2/P1/P0çš„æœ€å°å‘é€é—´éš”
- P0æ‰¹é‡å‘é€é…ç½®

### 3. notification_time_rules
é€šçŸ¥æ—¶é—´è§„åˆ™é…ç½®è¡¨
- å‹¿æ‰°æ—¶æ®µé…ç½®
- å·¥ä½œæ—¶é—´é…ç½®
- å‘¨æœ«/å‡æœŸæ¨¡å¼

### 4. notification_history
é€šçŸ¥å†å²è®°å½•è¡¨
- æ‰€æœ‰å‘é€çš„é€šçŸ¥è®°å½•
- å‘é€çŠ¶æ€ã€é”™è¯¯ä¿¡æ¯
- å…³è”çš„ç­–ç•¥IDã€ä¿¡å·ID

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1: ç­–ç•¥å¼•æ“å‘é€äº¤æ˜“ä¿¡å·

```python
# ç­–ç•¥äº§ç”Ÿæ–°ä¿¡å·æ—¶
async def on_new_signal(signal_data: Dict):
    strength = signal_data['signal_strength']

    # æ ¹æ®ä¿¡å·å¼ºåº¦è‡ªåŠ¨é€‰æ‹©ä¼˜å…ˆçº§
    priority = "P2" if strength >= 0.8 else "P1" if strength >= 0.5 else "P0"

    await notify_hub.notify(
        user_id=signal_data['user_id'],
        title=f"ğŸ“Š {signal_data['action']} ä¿¡å·: {signal_data['pair']}",
        message=f"ä¿¡å·å¼ºåº¦: {strength:.1%}\nä»·æ ¼: ${signal_data['price']:.2f}",
        notification_type="signal",
        priority=priority,
        metadata=signal_data,
        strategy_id=signal_data['strategy_id'],
        signal_id=signal_data['signal_id']
    )
```

### åœºæ™¯2: ç³»ç»Ÿç›‘æ§å‘é€å‘Šè­¦

```python
# ç­–ç•¥å¼‚å¸¸æ—¶
async def on_strategy_error(strategy_id: int, error_message: str):
    await notify_hub.notify(
        user_id=1,  # ç®¡ç†å‘˜
        title="ğŸš¨ ç­–ç•¥å¼‚å¸¸å‘Šè­¦",
        message=f"ç­–ç•¥ #{strategy_id} è¿è¡Œå¼‚å¸¸\né”™è¯¯: {error_message}",
        notification_type="alert",
        priority="P2",  # ç³»ç»Ÿå‘Šè­¦ï¼Œæœ€é«˜ä¼˜å…ˆçº§
        metadata={"strategy_id": strategy_id, "error": error_message},
        strategy_id=strategy_id
    )
```

### åœºæ™¯3: æ•°æ®åŒæ­¥å®Œæˆé€šçŸ¥

```python
# æ•°æ®åŒæ­¥å®Œæˆ
async def on_sync_completed(sync_stats: Dict):
    await notify_hub.notify(
        user_id=1,
        title="âœ… æ•°æ®åŒæ­¥å®Œæˆ",
        message=f"åŒæ­¥äº† {sync_stats['records']} æ¡è®°å½•",
        notification_type="info",
        priority="P0",  # ä¿¡æ¯ç±»é€šçŸ¥ï¼Œä½ä¼˜å…ˆçº§ï¼Œä¼šæ‰¹é‡å‘é€
        metadata=sync_stats
    )
```

---

## ğŸš€ å®ç°è®¡åˆ’

### Phase 1: æ ¸å¿ƒåŠŸèƒ½ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰
- [ ] NotifyHubæ ¸å¿ƒæœåŠ¡å®ç°
- [ ] è·¯ç”±å¼•æ“å®ç°
- [ ] é¢‘ç‡æ§åˆ¶å™¨å®ç°
- [ ] Telegramæ¸ é“é€‚é…å™¨
- [ ] Discordæ¸ é“é€‚é…å™¨ï¼ˆWebhook + Botæ¨¡å¼ï¼‰
- [ ] é£ä¹¦æ¸ é“é€‚é…å™¨
- [ ] åŸºç¡€APIå®ç°ï¼ˆå‘é€ã€é…ç½®ã€å†å²ï¼‰

### Phase 2: é«˜çº§åŠŸèƒ½ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰
- [ ] æ—¶é—´è§„åˆ™ç®¡ç†å™¨å®ç°
- [ ] æ‰¹é‡å‘é€æœºåˆ¶å®ç°
- [ ] é€šçŸ¥æ¨¡æ¿ç³»ç»Ÿå®ç°
- [ ] æ›´å¤šæ¸ é“é€‚é…å™¨ï¼ˆä¼ä¸šå¾®ä¿¡ã€é‚®ä»¶ã€çŸ­ä¿¡ï¼‰
- [ ] ç»Ÿè®¡å’Œåˆ†æAPI

### Phase 3: å‰ç«¯é›†æˆï¼ˆç¬¬ä¸‰é˜¶æ®µï¼‰
- [ ] é€šçŸ¥ä¸­å¿ƒé…ç½®é¡µé¢
- [ ] é€šçŸ¥å†å²æŸ¥çœ‹é¡µé¢
- [ ] é€šçŸ¥ç»Ÿè®¡å¤§ç›˜
- [ ] å®æ—¶é€šçŸ¥é¢„è§ˆå’Œæµ‹è¯•

---

## âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**è¯·æ‚¨ç¡®è®¤ï¼š**

1. **è®¾è®¡æ–¹æ¡ˆæ˜¯å¦ç¬¦åˆéœ€æ±‚ï¼Ÿ**
   - NotifyHubçš„ç»Ÿä¸€å…¥å£è®¾è®¡
   - ä¸‰çº§ä¼˜å…ˆçº§ç®¡ç†ï¼ˆP0/P1/P2ï¼‰
   - æ™ºèƒ½è·¯ç”±å’Œé¢‘ç‡æ§åˆ¶
   - æ—¶é—´è§„åˆ™ï¼ˆå‹¿æ‰°æ—¶æ®µã€å‘¨æœ«æ¨¡å¼ç­‰ï¼‰

2. **APIè®¾è®¡æ˜¯å¦åˆç†ï¼Ÿ**
   - é…ç½®ç®¡ç†APIæ˜¯å¦å®Œæ•´
   - é€šçŸ¥å‘é€æ¥å£æ˜¯å¦æ˜“ç”¨
   - æŸ¥è¯¢å’Œç»Ÿè®¡æ¥å£æ˜¯å¦æ»¡è¶³éœ€æ±‚

3. **æ•°æ®åº“è®¾è®¡æ˜¯å¦éœ€è¦è°ƒæ•´ï¼Ÿ**
   - 4å¼ æ ¸å¿ƒè¡¨æ˜¯å¦è¶³å¤Ÿ
   - å­—æ®µè®¾è®¡æ˜¯å¦åˆç†

4. **å®ç°ä¼˜å…ˆçº§ï¼Ÿ**
   - å“ªäº›åŠŸèƒ½éœ€è¦ä¼˜å…ˆå®ç°
   - å“ªäº›åŠŸèƒ½å¯ä»¥åç»­è¿­ä»£

**ç¡®è®¤åï¼Œæˆ‘å°†å¼€å§‹å®ç°NotifyHubé€šçŸ¥ä¸­å¿ƒç³»ç»Ÿï¼** ğŸ‰
