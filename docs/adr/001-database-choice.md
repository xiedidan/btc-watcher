# 1. 选择PostgreSQL作为主数据库

**日期**: 2025-01-10

**状态**: 已接受

**决策者**: BTC Watcher Architecture Team

---

## 上下文（Context）

### 问题陈述
BTC Watcher需要一个可靠的关系型数据库来存储：
- 用户信息和认证数据
- 策略配置（支持999个并发策略）
- 交易信号历史记录
- 系统监控数据
- WebSocket连接状态

我们需要选择一个能满足以下需求的数据库：
- 支持高并发读写（1000+ QPS）
- 支持复杂查询和关联
- 数据一致性保证（ACID）
- 良好的JSON支持（策略配置是JSON格式）
- 成熟的Python ORM支持

### 约束条件
- **技术约束**: 必须支持Python异步操作（asyncio/async-await）
- **业务约束**: 需要存储结构化数据，数据关系复杂
- **时间约束**: 需要快速上手，团队学习成本低
- **资源约束**: 开源方案，无许可证成本

### 当前状况
项目初期阶段，尚未选定数据库。需要在项目启动前确定技术栈。

---

## 决策（Decision）

### 决策内容
选择 **PostgreSQL 15** 作为BTC Watcher的主数据库，配合 **SQLAlchemy 2.0** 异步ORM使用。

### 选择理由

1. **强大的ACID支持**: PostgreSQL提供完整的事务支持，保证数据一致性，这对金融交易场景至关重要

2. **优秀的并发性能**: MVCC（多版本并发控制）机制，支持高并发读写而不会阻塞

3. **丰富的数据类型**:
   - 原生JSON/JSONB支持，适合存储策略配置
   - Array类型，可以存储标签列表等
   - 自定义类型，灵活扩展

4. **成熟的异步支持**: SQLAlchemy 2.0完美支持PostgreSQL的异步操作，配合asyncpg驱动性能优异

5. **强大的查询能力**:
   - 支持复杂JOIN和子查询
   - 支持全文搜索
   - 支持JSON路径查询
   - 丰富的聚合函数

6. **团队熟悉度**: 团队成员有PostgreSQL使用经验，可以快速上手

7. **生态系统**:
   - 成熟的备份恢复工具（pg_dump, pg_restore）
   - 丰富的监控工具（pg_stat, pgAdmin）
   - 活跃的社区支持

### 预期目标
- API响应时间 < 100ms（P90）
- 支持1000+ QPS并发请求
- 数据零丢失
- 易于维护和扩展

---

## 备选方案（Alternatives Considered）

### 方案A: MySQL

**描述**: 使用MySQL作为关系型数据库

**优点**:
- 简单易用，学习曲线平缓
- 广泛应用，文档丰富
- 读性能优秀
- 社区庞大

**缺点**:
- JSON支持较弱（MySQL 5.7+才支持，功能不如PostgreSQL）
- 复杂查询性能不如PostgreSQL
- 并发控制机制相对简单（表锁/行锁）
- 异步支持不如PostgreSQL成熟
- 事务隔离级别默认为REPEATABLE READ，可能导致间隙锁问题

**为什么没选择**:
虽然MySQL简单易用，但在复杂查询、JSON支持和并发控制方面不如PostgreSQL，不能很好地满足我们的需求。

---

### 方案B: MongoDB

**描述**: 使用MongoDB作为NoSQL文档数据库

**优点**:
- 灵活的Schema设计
- 原生JSON文档存储
- 水平扩展容易
- 高写入性能
- 适合快速迭代

**缺点**:
- 缺乏事务支持（4.0之前完全不支持，4.0+支持但性能差）
- 不适合复杂关联查询
- 数据一致性保证较弱
- 团队不熟悉，学习成本高
- 对于结构化数据（用户、策略等）过于灵活

**为什么没选择**:
虽然MongoDB擅长灵活Schema和高写入，但我们的数据模型相对固定且关系复杂，更适合关系型数据库。缺乏强事务支持也是金融场景的隐患。

---

### 方案C: TimescaleDB

**描述**: 使用TimescaleDB（基于PostgreSQL的时序数据库扩展）

**优点**:
- 基于PostgreSQL，保留所有PG特性
- 专为时序数据优化
- 优秀的压缩能力
- 自动分区管理
- 高性能时间范围查询

**缺点**:
- 学习曲线较陡
- 增加了复杂度
- 对于非时序数据是过度设计
- 团队经验不足
- 部署和运维更复杂

**为什么没选择**:
虽然我们有时序数据（信号历史），但不是核心需求。使用TimescaleDB会增加不必要的复杂度，标准PostgreSQL已足够满足需求。

---

## 后果（Consequences）

### 正面影响

#### 技术层面
- **强大的查询能力**: 支持复杂的业务查询需求
- **数据一致性**: ACID特性保证金融数据准确性
- **JSON支持**: JSONB类型完美支持策略配置存储
- **异步性能**: 配合SQLAlchemy 2.0实现高性能异步操作
- **扩展性**: 支持分区表、索引优化等高级特性

#### 业务层面
- **快速开发**: 成熟的ORM减少开发时间
- **数据可靠**: 强事务支持，适合金融场景
- **灵活查询**: 支持复杂的数据分析需求

#### 团队层面
- **快速上手**: 团队有PostgreSQL经验
- **问题解决**: 丰富的文档和社区支持
- **技能提升**: 学习行业标准数据库

### 负面影响

#### 技术债务
- **垂直扩展限制**: 单机性能有上限，需要后期考虑分库分表
- **复杂查询优化**: 需要DBA经验进行查询优化
- **VACUUM维护**: 需要定期VACUUM防止膨胀

#### 限制
- **水平扩展复杂**: 不如MongoDB/Cassandra易于分布式部署
- **内存占用**: 相对MySQL内存占用较高
- **冷数据处理**: 历史数据归档需要额外方案

#### 成本
- **硬件成本**: 内存需求较高
- **运维成本**: 需要专业的数据库运维知识
- **监控成本**: 需要部署监控和告警系统

### 风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 单点故障 | 中 | 高 | 配置主从复制和故障转移 |
| 性能瓶颈 | 中 | 中 | 添加索引、查询优化、连接池配置 |
| 数据膨胀 | 高 | 中 | 定期VACUUM、归档历史数据 |
| 查询慢 | 中 | 中 | 使用EXPLAIN分析、添加合适索引 |
| 连接数不足 | 低 | 高 | 配置连接池（pgbouncer）|

---

## 实施计划（Implementation）

### 实施步骤

1. **环境搭建**: Docker容器化部署PostgreSQL 15
   - 负责人: DevOps Team
   - 预计时间: 1天
   - 依赖: Docker环境

2. **数据库设计**: 设计数据库Schema和ER图
   - 负责人: Backend Team
   - 预计时间: 2-3天
   - 依赖: 需求文档

3. **ORM配置**: 配置SQLAlchemy 2.0异步连接
   - 负责人: Backend Team
   - 预计时间: 1天
   - 依赖: 数据库设计完成

4. **迁移工具**: 配置Alembic数据库迁移工具
   - 负责人: Backend Team
   - 预计时间: 1天
   - 依赖: ORM配置完成

5. **连接池优化**: 配置合理的连接池参数
   - 负责人: Backend Team
   - 预计时间: 0.5天
   - 依赖: 基本功能测试完成

6. **备份方案**: 设置定期备份和恢复测试
   - 负责人: DevOps Team
   - 预计时间: 1天
   - 依赖: 数据库运行稳定

7. **监控告警**: 部署数据库监控和告警
   - 负责人: DevOps Team
   - 预计时间: 1天
   - 依赖: 基础功能完成

### 验证标准

- [x] 数据库容器成功启动
- [x] SQLAlchemy异步连接测试通过
- [x] Alembic迁移功能正常
- [x] API响应时间达标（< 100ms P90）
- [ ] 并发测试通过（1000+ QPS）
- [ ] 备份恢复流程验证
- [ ] 监控告警正常工作

### 回退计划

如果PostgreSQL出现严重问题：

1. **短期方案**: 降级使用SQLite（仅开发环境）
2. **中期方案**: 切换到MySQL（需要迁移JSONB字段）
3. **长期方案**: 重新评估数据库选型

---

## 参考资料（References）

### 相关文档
- [数据库设计文档](../architecture/database-design.md)
- [系统架构设计](../architecture/system-design.md)

### 技术文章
- [PostgreSQL官方文档](https://www.postgresql.org/docs/15/)
- [SQLAlchemy 2.0异步支持](https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html)
- [Why Uber Engineering Switched from Postgres to MySQL](https://eng.uber.com/postgres-to-mysql-migration/) - 反面案例分析

### 讨论记录
- 团队技术选型会议 2025-01-08

### 相关ADR
- ADR-002: WebSocket实时推送架构（依赖本决策）

### 代码示例
- [FastAPI + PostgreSQL异步示例](https://github.com/tiangolo/fastapi/tree/master/docs_src/sql_databases)

---

## 更新历史

| 日期 | 作者 | 变更内容 |
|------|------|----------|
| 2025-01-10 | Architecture Team | 初始版本 |
| 2025-01-15 | Backend Team | 补充实施进度 |

---

## 备注

**连接池配置推荐**:
- 最小连接数: 5
- 最大连接数: 20
- 连接超时: 30秒
- 空闲超时: 300秒

**索引策略**:
- 所有外键添加索引
- 频繁查询字段添加索引
- 使用EXPLAIN ANALYZE分析慢查询

**维护计划**:
- 每周执行VACUUM ANALYZE
- 每月检查数据库膨胀
- 每季度优化索引

---

**标签**: #架构决策 #数据库 #PostgreSQL #技术选型

**关联Issue**: N/A

**关联PR**: N/A
